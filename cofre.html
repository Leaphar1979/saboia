<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cofre Sats - Simple$</title>

  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#f7941d">

  <style>
    .vault-container {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
      border: 1px solid #eef1f5;
      text-align: center;
    }
    .vault-balance {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 8px 0;
    }
    .vault-actions {
      display:flex;
      gap:8px;
      justify-content:center;
      margin: 12px 0 4px;
      flex-wrap: wrap;
    }
    .btn-outline {
      background:#fff;
      color:#333;
      border:1px solid #ddd;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition: background .15s ease;
    }
    .btn-outline:hover { background:#f7f7f7; }
    .vault-history {
      margin-top: 16px;
      text-align: left;
    }
    .vault-history h3 { margin-bottom: 8px; }
    .vault-history ul { padding: 0; list-style: none; }
    .vault-history li {
      padding: 6px;
      background: #f2f4f8;
      margin-bottom: 4px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delta-pos { color: #28a745; }
    .delta-neg { color: #dc3545; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <main>
    <section>
      <h1>Cofre Sats</h1>

      <div class="vault-container">
        <p>Total acumulado:</p>
        <div class="vault-balance" id="vaultTotal">R$ 0,00</div>
        <small class="muted">Equivalente aproximado em BTC (valor fixo de referência)</small>
        <div id="vaultBtc">₿ 0.00000000</div>

        <div class="vault-actions">
          <button id="btnPurchase" class="btn-outline">Registrar compra de BTC (zerar cofre)</button>
        </div>
      </div>

      <div class="vault-history">
        <h3>Histórico</h3>
        <ul id="vaultList"></ul>
      </div>

      <p style="text-align:center; margin-top: 16px;">
        <a href="index.html" class="link-muted">⬅ Voltar ao Simple$</a>
      </p>
    </section>
  </main>

  <script>
    const SATS_VAULT_KEY = "satsVault/v1";
    const SATS_LEDGER_KEY = "satsLedger/v1";
    const fmtBRL = n => Number(n||0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    const fmtBTC = n => "₿ " + (Number(n||0)).toFixed(8);
    const round2 = n => Math.round((Number(n)+Number.EPSILON)*100)/100;

    // valor aproximado do BTC em BRL (ajuste manual quando quiser)
    const BTC_PRICE = 350000;

    function loadVaultValue() {
      const v = parseFloat(localStorage.getItem(SATS_VAULT_KEY) || "0");
      return isNaN(v) ? 0 : v;
    }
    function setVaultValue(v) {
      localStorage.setItem(SATS_VAULT_KEY, String(Math.max(0, round2(v))));
    }

    function loadLedger() {
      try { return JSON.parse(localStorage.getItem(SATS_LEDGER_KEY) || "[]"); }
      catch { return []; }
    }
    function saveLedger(arr) {
      localStorage.setItem(SATS_LEDGER_KEY, JSON.stringify(arr));
    }
    function addLedger(delta, type) {
      if (!delta) return;
      const now = new Date();
      const item = {
        ts: now.toISOString(),
        date: now.toISOString().slice(0,10),
        delta: round2(delta),
        type
      };
      const arr = loadLedger();
      arr.push(item);
      saveLedger(arr);
    }

    function typeLabel(t) {
      switch (t) {
        case "apply": return "Taxa aplicada";
        case "edit": return "Ajuste (edição)";
        case "delete": return "Excluído (estorno)";
        case "purchase": return "Compra BTC (saída)";
        default: return "Movimentação";
      }
    }

    function render() {
      const vault = loadVaultValue();
      document.getElementById("vaultTotal").textContent = fmtBRL(vault);
      document.getElementById("vaultBtc").textContent = fmtBTC(vault / BTC_PRICE);

      const list = document.getElementById("vaultList");
      list.innerHTML = "";
      const ledger = loadLedger().slice().reverse(); // mais recentes primeiro

      if (ledger.length === 0) {
        list.innerHTML = "<li class='muted'>Nenhuma movimentação ainda.</li>";
        return;
      }

      ledger.forEach(item => {
        const li = document.createElement("li");
        const left = document.createElement("span");
        const right = document.createElement("span");

        const dateStr = item.date ? new Date(item.date).toLocaleDateString("pt-BR") : (item.ts || "").slice(0,10);
        left.textContent = `${dateStr} — ${typeLabel(item.type)}`;

        const delta = Number(item.delta || 0);
        right.textContent = (delta >= 0 ? "+" : "") + fmtBRL(delta);
        right.className = delta >= 0 ? "delta-pos" : "delta-neg";

        li.appendChild(left);
        li.appendChild(right);
        list.appendChild(li);
      });

      // estado do botão
      const btn = document.getElementById("btnPurchase");
      btn.disabled = vault <= 0;
      btn.style.opacity = vault <= 0 ? .6 : 1;
      btn.style.cursor = vault <= 0 ? "not-allowed" : "pointer";
    }

    function onPurchase() {
      const cur = loadVaultValue();
      if (cur <= 0) return;
      if (!confirm(`Confirmar: registrar compra de BTC e zerar cofre (${fmtBRL(cur)})?`)) return;

      addLedger(-cur, "purchase");
      setVaultValue(0);
      render();
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();
      document.getElementById("btnPurchase").addEventListener("click", onPurchase);
    });
  </script>
</body>
</html>
