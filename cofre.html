<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cofre Sats - Simple$</title>

  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#f7941d">

  <style>
    .vault-container {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
      border: 1px solid #eef1f5;
      text-align: center;
    }
    .vault-balance {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 8px 0;
    }
    .vault-actions {
      display:flex;
      gap:8px;
      justify-content:center;
      margin: 12px 0 4px;
      flex-wrap: wrap;
    }
    .btn-outline {
      background:#fff;
      color:#333;
      border:1px solid #ddd;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition: background .15s ease;
    }
    .btn-outline:hover { background:#f7f7f7; }
    .vault-history {
      margin-top: 16px;
      text-align: left;
    }
    .vault-history h3 { margin-bottom: 8px; }
    .vault-history ul { padding: 0; list-style: none; }
    .vault-history li {
      padding: 6px;
      background: #f2f4f8;
      margin-bottom: 4px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delta-pos { color: #28a745; }
    .delta-neg { color: #dc3545; }
    .muted { color: #666; }
    .price-line { margin-top: 6px; font-size:.95rem; }
    .small { font-size: .85rem; }
  </style>
</head>
<body>
  <main>
    <section>
      <h1>Cofre Sats</h1>

      <div class="vault-container">
        <p>Total acumulado:</p>
        <div class="vault-balance" id="vaultTotal">R$ 0,00</div>

        <div class="price-line">
          <span class="muted">Equivalente em BTC — Fonte:</span>
          <strong id="priceSource">—</strong>
          <span class="muted"> (1 BTC = </span><strong id="btcPriceBRL">—</strong><span class="muted">)</span>
        </div>

        <div id="vaultBtc" style="margin-top:6px;">₿ —</div>
        <div class="small muted" id="lastUpdated" style="margin-top:4px;">Última atualização: —</div>

        <div class="vault-actions">
          <button id="btnPurchase" class="btn-outline" disabled>Registrar compra de BTC (zerar cofre)</button>
          <button id="btnRefresh" class="btn-outline" title="Atualizar cotação e totais">Atualizar</button>
        </div>
      </div>

      <div class="vault-history">
        <h3>Histórico</h3>
        <ul id="vaultList"></ul>
      </div>

      <p style="text-align:center; margin-top: 16px;">
        <a href="index.html" class="link-muted">⬅ Voltar ao Simple$</a>
      </p>
    </section>
  </main>

  <script>
    // === CHAVES ===
    const SATS_VAULT_KEY  = "satsVault/v1";
    const SATS_LEDGER_KEY = "satsLedger/v1";
    const PRICE_CACHE_KEY = "btcPriceBRL/cache";
    const PRICE_TTL_MIN   = 10; // minutos

    // === HELPERS ===
    const fmtBRL = n => Number(n||0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    const fmtBTC = n => "₿ " + (Number(n||0)).toFixed(8);
    const round2 = n => Math.round((Number(n)+Number.EPSILON)*100)/100;

    const setLastUpdated = (d) => {
      const el = document.getElementById("lastUpdated");
      if (!el) return;
      if (!d) { el.textContent = "Última atualização: —"; return; }
      const dt = new Date(d);
      el.textContent = "Última atualização: " + dt.toLocaleString("pt-BR");
    };

    // === STORAGE (app) ===
    const loadVaultValue = () => {
      const v = parseFloat(localStorage.getItem(SATS_VAULT_KEY) || "0");
      return isNaN(v) ? 0 : v;
    };
    const setVaultValue = (v) =>
      localStorage.setItem(SATS_VAULT_KEY, String(Math.max(0, round2(v))));

    const loadLedger = () => {
      try { return JSON.parse(localStorage.getItem(SATS_LEDGER_KEY) || "[]"); }
      catch { return []; }
    };
    const saveLedger = (arr) =>
      localStorage.setItem(SATS_LEDGER_KEY, JSON.stringify(arr));
    const addLedger = (delta, type) => {
      if (!delta) return;
      const now = new Date();
      const item = {
        ts: now.toISOString(),
        date: now.toISOString().slice(0,10),
        delta: round2(delta),
        type // 'apply'|'edit'|'delete'|'purchase'
      };
      const arr = loadLedger();
      arr.push(item);
      saveLedger(arr);
    };

    // === STORAGE (preço) ===
    function loadCachedPrice() {
      try {
        const raw = localStorage.getItem(PRICE_CACHE_KEY);
        if (!raw) return null;
        const { price, source, ts } = JSON.parse(raw);
        if (!price || !source || !ts) return null;
        const ageMin = (Date.now() - ts) / 60000;
        if (ageMin > PRICE_TTL_MIN) return null;
        return { price, source, ts };
      } catch { return null; }
    }
    function saveCachedPrice(priceBRL, source) {
      try {
        localStorage.setItem(PRICE_CACHE_KEY, JSON.stringify({ price: priceBRL, source, ts: Date.now() }));
      } catch {}
    }

    // === COTAÇÃO AO VIVO: CoinGecko → Binance (fallback) ===
    async function fetchPriceBRL_withSource() {
      // 1) CoinGecko
      try {
        const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=brl", { cache: "no-store" });
        if (r.ok) {
          const j = await r.json();
          const price = Number(j?.bitcoin?.brl);
          if (price > 0) return { price, source: "CoinGecko" };
        }
      } catch {}

      // 2) Binance
      try {
        const r = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BTCBRL", { cache: "no-store" });
        if (r.ok) {
          const j = await r.json();
          const price = Number(j?.price);
          if (price > 0) return { price, source: "Binance" };
        }
      } catch {}

      return null;
    }

    async function getPriceBRL_withSource() {
      const cached = loadCachedPrice();
      if (cached) return cached;
      const live = await fetchPriceBRL_withSource();
      if (live) saveCachedPrice(live.price, live.source);
      return live ? { ...live, ts: Date.now() } : null;
    }

    // === RENDER ===
    function renderLedger(listEl) {
      listEl.innerHTML = "";
      const ledger = loadLedger().slice().reverse();
      if (ledger.length === 0) {
        listEl.innerHTML = "<li class='muted'>Nenhuma movimentação ainda.</li>";
        return;
      }
      for (const item of ledger) {
        const li = document.createElement("li");
        const left = document.createElement("span");
        const right = document.createElement("span");

        const dateStr = item.date ? new Date(item.date).toLocaleDateString("pt-BR") : (item.ts||"").slice(0,10);
        left.textContent = `${dateStr} — ${typeLabel(item.type)}`;

        const delta = Number(item.delta||0);
        right.textContent = (delta >= 0 ? "+" : "") + fmtBRL(delta);
        right.className = delta >= 0 ? "delta-pos" : "delta-neg";

        li.appendChild(left);
        li.appendChild(right);
        listEl.appendChild(li);
      }
    }

    function typeLabel(t) {
      switch (t) {
        case "apply": return "Taxa aplicada";
        case "edit": return "Ajuste (edição)";
        case "delete": return "Excluído (estorno)";
        case "purchase": return "Compra BTC (saída)";
        default: return "Movimentação";
      }
    }

    async function renderAll() {
      const vault = loadVaultValue();
      document.getElementById("vaultTotal").textContent = fmtBRL(vault);

      // estado do botão antes de buscar preço
      const btn = document.getElementById("btnPurchase");
      btn.disabled = vault <= 0;
      btn.style.opacity = vault <= 0 ? .6 : 1;
      btn.style.cursor = vault <= 0 ? "not-allowed" : "pointer";

      const pricePkg = await getPriceBRL_withSource();
      const priceEl = document.getElementById("btcPriceBRL");
      const sourceEl = document.getElementById("priceSource");
      const vaultBtcEl = document.getElementById("vaultBtc");

      if (pricePkg && pricePkg.price) {
        priceEl.textContent = fmtBRL(pricePkg.price);
        sourceEl.textContent = pricePkg.source;
        vaultBtcEl.textContent = fmtBTC(vault / pricePkg.price);
        setLastUpdated(pricePkg.ts);
      } else {
        priceEl.textContent = "indisponível no momento";
        sourceEl.textContent = "—";
        vaultBtcEl.textContent = "₿ —";
        setLastUpdated(null);
      }

      renderLedger(document.getElementById("vaultList"));
    }

    // === AÇÕES ===
    function onPurchase() {
      const cur = loadVaultValue();
      if (cur <= 0) return;
      if (!confirm(`Confirmar: registrar compra de BTC e zerar cofre (${fmtBRL(cur)})?`)) return;
      addLedger(-cur, "purchase");
      setVaultValue(0);
      renderAll();
    }

    function onRefresh() {
      // força ignorar cache: limpa e renderiza novamente
      localStorage.removeItem(PRICE_CACHE_KEY);
      renderAll();
    }

    // === BOOT ===
    document.addEventListener("DOMContentLoaded", () => {
      renderAll();
      document.getElementById("btnPurchase").addEventListener("click", onPurchase);
      document.getElementById("btnRefresh").addEventListener("click", onRefresh);
    });
  </script>
</body>
</html>
